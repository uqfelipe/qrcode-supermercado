<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        #interactive {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        #productInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
        }
        #zoomControls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        #zoomControls button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="interactive"></div>
    <div id="productInfo" style="display: none;">
        <h3>Informações do Produto:</h3>
        <p id="productName"></p>
        <p id="productPrice"></p>
        <button id="readAgainBtn" style="display: none;">Ler novamente</button>
    </div>

    <script>
        function startQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: { min: 1920, ideal: 3840, max: 7680 }, // Suporte para 4K e 8K
                        height: { min: 1080, ideal: 2160, max: 4320 },
                        facingMode: "environment", 
                        focusMode: "continuous",
                        zoom: 2, // Zoom digital inicial
                        frameRate: { ideal: 60, max: 120 } // Aumenta a taxa de quadros
                    }
                },
                decoder: {
                    readers: ["ean_reader"],
                },
                locate: true,
                locator: {
                    patchSize: "x-large", // Aumenta a área de detecção
                    halfSample: false // Melhor qualidade de detecção
                },
                numOfWorkers: navigator.hardwareConcurrency ? navigator.hardwareConcurrency : 4,
                frequency: 10,
                debug: false,
            }, function(err) {
                if (err) {
                    console.log(err);
                    return;
                }
                console.log("Leitura iniciada");
                Quagga.start();

                // Adiciona controles de zoom após iniciar
                adicionarControlesZoom();
            });
        }

        // Função para adicionar controles de zoom na interface
        function adicionarControlesZoom() {
            const zoomControls = document.createElement('div');
            zoomControls.id = 'zoomControls';
            zoomControls.innerHTML = `
                <button id="zoomIn">+</button>
                <button id="zoomOut">-</button>
            `;
            document.querySelector('#interactive').appendChild(zoomControls);

            let currentZoom = 2; // Zoom inicial de 2x
            document.getElementById('zoomIn').addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + 0.5, 8); // Limita o zoom máximo a 8x
                aplicarZoom(currentZoom);
            });
            document.getElementById('zoomOut').addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - 0.5, 1); // Limita o zoom mínimo a 1x
                aplicarZoom(currentZoom);
            });
        }

        // Função para aplicar o zoom digital na câmera
        function aplicarZoom(zoom) {
            const videoTrack = Quagga.CameraAccess.getActiveTrack();
            if (videoTrack && typeof videoTrack.getCapabilities === 'function') {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.zoom) {
                    videoTrack.applyConstraints({ advanced: [{ zoom: zoom }] })
                        .catch(e => console.error("Erro ao aplicar zoom:", e));
                }
            }
        }

        // Inicia o Quagga ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            startQuagga();

            // Função simulada para quando um produto é detectado
            function produtoDetectado(dados) {
                if (dados) {
                    document.getElementById("productInfo").style.display = 'block';
                    document.getElementById("productName").innerText = "Nome: " + dados.nome;
                    document.getElementById("productPrice").innerText = "Preço: R$" + dados.preco;

                    // Esconde a câmera e o campo de entrada
                    document.getElementById("interactive").style.display = 'none';
                    document.getElementById("manualInput").style.display = 'none';

                    // Para o Quagga
                    Quagga.stop();
                } else {
                    alert("Produto não encontrado.");
                }
            }

            // Botão para ler o código novamente
            document.getElementById("readAgainBtn").addEventListener("click", function() {
                document.getElementById("productInfo").style.display = 'none';

                // Mostra a câmera e o campo de entrada novamente
                document.getElementById("interactive").style.display = 'block';

                // Esconde o botão de ler novamente
                document.getElementById("readAgainBtn").style.display = 'none';

                // Reinicia o Quagga
                startQuagga();
            });
        });
    </script>
</body>
</html>
