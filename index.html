<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        #interactive {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        #scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: red;
            top: 50%;
            animation: scanning 2s infinite;
        }
        @keyframes scanning {
            0% { top: 0%; }
            100% { top: 100%; }
        }
        #productInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        #zoomControls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        #zoomControls button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #zoomControls button:hover {
            background-color: #0056b3;
        }
        #barcodeInput {
            display: none;
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div id="interactive">
        <div id="scanner-line"></div>
    </div>
    <div id="productInfo">
        <h3>Informações do Produto:</h3>
        <p id="productName"></p>
        <p id="productPrice"></p>
        <button id="readAgainBtn">Ler novamente</button>
    </div>
    <div id="barcodeInput">
        <h3>Digite o código de barras:</h3>
        <input type="text" id="manualBarcode" placeholder="Código de Barras">
        <button id="submitBarcode">Enviar</button>
    </div>

    <div id="zoomControls">
        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
    </div>

    <script>
        function startQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: { min: 1920, ideal: 3840, max: 7680 }, // Suporte para 4K e 8K
                        height: { min: 1080, ideal: 2160, max: 4320 },
                        facingMode: "environment", 
                        focusMode: "continuous",
                        zoom: 2, // Zoom digital inicial
                        frameRate: { ideal: 60, max: 120 } // Aumenta a taxa de quadros
                    }
                },
                decoder: {
                    readers: ["ean_reader"],
                },
                locate: true,
                locator: {
                    patchSize: "x-large", // Aumenta a área de detecção
                    halfSample: false // Melhor qualidade de detecção
                },
                numOfWorkers: navigator.hardwareConcurrency ? navigator.hardwareConcurrency : 4,
                frequency: 10,
                debug: false,
            }, function(err) {
                if (err) {
                    console.log(err);
                    return;
                }
                console.log("Leitura iniciada");
                Quagga.start();

                // Adiciona controles de zoom após iniciar
                adicionarControlesZoom();
            });
        }

        // Função para adicionar controles de zoom na interface
        function adicionarControlesZoom() {
            let currentZoom = 2; // Zoom inicial de 2x
            document.getElementById('zoomIn').addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + 0.5, 8); // Limita o zoom máximo a 8x
                aplicarZoom(currentZoom);
            });
            document.getElementById('zoomOut').addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - 0.5, 1); // Limita o zoom mínimo a 1x
                aplicarZoom(currentZoom);
            });
        }

        // Função para aplicar o zoom digital na câmera
        function aplicarZoom(zoom) {
            const videoTrack = Quagga.CameraAccess.getActiveTrack();
            if (videoTrack && typeof videoTrack.getCapabilities === 'function') {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.zoom) {
                    videoTrack.applyConstraints({ advanced: [{ zoom: zoom }] })
                        .catch(e => console.error("Erro ao aplicar zoom:", e));
                }
            }
        }

        // Inicia o Quagga ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            startQuagga();

            // Botão para ler o código novamente
            document.getElementById("readAgainBtn").addEventListener("click", function() {
                document.getElementById("productInfo").style.display = 'none';
                document.getElementById("interactive").style.display = 'block';
                document.getElementById("barcodeInput").style.display = 'none';

                // Reinicia o Quagga
                startQuagga();
            });

            // Simula o envio manual do código de barras
            document.getElementById("submitBarcode").addEventListener("click", function() {
                const barcode = document.getElementById("manualBarcode").value;
                produtoDetectado({ nome: "Produto Manual", preco: "00,00" });
            });
        });

        // Simula a detecção de produto e exibe informações
        function produtoDetectado(dados) {
            if (dados) {
                document.getElementById("productInfo").style.display = 'block';
                document.getElementById("productName").innerText = "Nome: " + dados.nome;
                document.getElementById("productPrice").innerText = "Preço: R$" + dados.preco;

                // Esconde a câmera e o campo de entrada manual
                document.getElementById("interactive").style.display = 'none';
                document.getElementById("barcodeInput").style.display = 'none';

                // Para o Quagga
                Quagga.stop();
            } else {
                alert("Produto não encontrado.");
            }
        }
    </script>
</body>
</html>
